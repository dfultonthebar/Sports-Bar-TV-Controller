import { chromium } from 'playwright'
import * as fs from 'fs'
import * as path from 'path'

const SCREENSHOT_DIR = '/tmp/ui-screenshots/layout-editor'

interface TestResult {
  name: string
  passed: boolean
  error?: string
  consoleMessages: string[]
  networkErrors: string[]
  screenshots: string[]
}

const results: TestResult[] = []

async function ensureScreenshotDir() {
  if (!fs.existsSync(SCREENSHOT_DIR)) {
    fs.mkdirSync(SCREENSHOT_DIR, { recursive: true })
  }
}

async function testLayoutEditor() {
  const browser = await chromium.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  })

  const context = await browser.newContext({
    viewport: { width: 1920, height: 1080 }
  })

  const page = await context.newPage()

  // Collect console messages and network errors
  const consoleMessages: string[] = []
  const networkErrors: string[] = []
  const requestUrls: string[] = []

  page.on('console', msg => {
    const text = `[${msg.type().toUpperCase()}] ${msg.text()}`
    consoleMessages.push(text)
    if (msg.type() === 'error') {
      console.log(`Browser Error: ${text}`)
    }
  })

  page.on('request', request => {
    requestUrls.push(`${request.method()} ${request.url()}`)
  })

  page.on('response', response => {
    if (!response.ok()) {
      const error = `${response.status()} ${response.statusText()} - ${response.url()}`
      networkErrors.push(error)
      console.log(`Network Error: ${error}`)
    }
  })

  page.on('requestfailed', request => {
    const error = `Failed: ${request.url()} - ${request.failure()?.errorText}`
    networkErrors.push(error)
    console.log(`Request Failed: ${error}`)
  })

  try {
    // Test 1: Load layout editor page
    console.log('\n=== Test 1: Loading Layout Editor Page ===')
    const testResult1: TestResult = {
      name: 'Load Layout Editor Page',
      passed: false,
      consoleMessages: [],
      networkErrors: [],
      screenshots: []
    }

    try {
      await page.goto('http://localhost:3001/layout-editor', {
        waitUntil: 'networkidle',
        timeout: 10000
      })

      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(500)

      // Capture initial page
      const screenshotPath1 = path.join(SCREENSHOT_DIR, '01-layout-editor-initial.png')
      await page.screenshot({ path: screenshotPath1, fullPage: true })
      testResult1.screenshots.push(screenshotPath1)

      console.log('✓ Layout editor page loaded successfully')
      testResult1.passed = true
    } catch (error: any) {
      testResult1.error = error.message
      console.log(`✗ Failed to load layout editor: ${error.message}`)
    }

    testResult1.consoleMessages = [...consoleMessages]
    testResult1.networkErrors = [...networkErrors]
    results.push(testResult1)

    // Test 2: Check if file input is present and functional
    console.log('\n=== Test 2: File Input Element Check ===')
    const testResult2: TestResult = {
      name: 'File Input Element Check',
      passed: false,
      consoleMessages: [],
      networkErrors: [],
      screenshots: []
    }

    try {
      const fileInput = page.locator('input[type="file"]')
      const fileInputCount = await fileInput.count()
      console.log(`Found ${fileInputCount} file input element(s)`)

      if (fileInputCount > 0) {
        const isVisible = await fileInput.isVisible()
        console.log(`File input visible: ${isVisible}`)

        // Check input attributes
        const accept = await fileInput.getAttribute('accept')
        console.log(`Accept attribute: ${accept}`)

        testResult2.passed = true
      } else {
        testResult2.error = 'No file input element found'
      }
    } catch (error: any) {
      testResult2.error = error.message
      console.log(`✗ File input check failed: ${error.message}`)
    }

    testResult2.consoleMessages = [...consoleMessages]
    testResult2.networkErrors = [...networkErrors]
    results.push(testResult2)

    // Test 3: Verify UI elements
    console.log('\n=== Test 3: UI Elements Verification ===')
    const testResult3: TestResult = {
      name: 'UI Elements Verification',
      passed: false,
      consoleMessages: [],
      networkErrors: [],
      screenshots: []
    }

    try {
      // Check for essential elements
      const heading = page.locator('h1')
      const uploadButton = page.locator('button:has-text("Choose Image")')
      const scanButton = page.locator('button:has-text("Upload & Auto-Detect")')
      const layoutPreview = page.locator('text=Layout Preview')

      const headingExists = await heading.count() > 0
      const uploadButtonExists = await uploadButton.count() > 0
      const scanButtonExists = await scanButton.count() > 0
      const layoutPreviewExists = await layoutPreview.count() > 0

      console.log(`Heading present: ${headingExists}`)
      console.log(`Upload button present: ${uploadButtonExists}`)
      console.log(`Scan button present: ${scanButtonExists}`)
      console.log(`Layout preview section present: ${layoutPreviewExists}`)

      testResult3.passed = headingExists && uploadButtonExists && scanButtonExists && layoutPreviewExists
    } catch (error: any) {
      testResult3.error = error.message
      console.log(`✗ UI elements verification failed: ${error.message}`)
    }

    testResult3.consoleMessages = [...consoleMessages]
    testResult3.networkErrors = [...networkErrors]
    results.push(testResult3)

    // Test 4: Test file selection (without actual upload)
    console.log('\n=== Test 4: File Selection Interaction ===')
    const testResult4: TestResult = {
      name: 'File Selection Interaction',
      passed: false,
      consoleMessages: [],
      networkErrors: [],
      screenshots: []
    }

    try {
      const fileInput = page.locator('input[type="file"]')

      // Try to set file via Playwright
      const testImagePath = '/tmp/test-layout.png'

      // Create a test image if it doesn't exist
      if (!fs.existsSync(testImagePath)) {
        // Create a simple 100x100 red PNG
        const buffer = Buffer.from([
          0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
          0x00, 0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x64, 0x08, 0x02, 0x00, 0x00, 0x00, 0x48, 0x45, 0x67,
          0x45, 0x00, 0x00, 0x00, 0x19, 0x74, 0x45, 0x58, 0x74, 0x53, 0x6f, 0x66, 0x74, 0x77, 0x61, 0x72,
          0x65, 0x00, 0x41, 0x64, 0x6f, 0x62, 0x65, 0x20, 0x49, 0x6d, 0x61, 0x67, 0x65, 0x52, 0x65, 0x61,
          0x64, 0x79, 0x71, 0xc9, 0x65, 0x3c, 0x00, 0x00, 0x03, 0x7d, 0x49, 0x44, 0x41, 0x54, 0x78, 0xda,
          0xec, 0xdd, 0xb1, 0x0d, 0x80, 0x30, 0x0c, 0x04, 0xb0, 0x76, 0x62, 0xa0, 0x84, 0x90, 0xa4, 0x0a,
          0x26, 0x04, 0x41, 0x0a, 0x41, 0x42, 0x01, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
          0xff, 0xf7, 0x65, 0x19, 0x48, 0x3e, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00, 0xff, 0xff, 0x03, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x87, 0x0b, 0x5f, 0x8d, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82
        ])
        fs.writeFileSync(testImagePath, buffer)
        console.log('Created test image at', testImagePath)
      }

      await fileInput.setInputFiles(testImagePath)
      console.log('File selected successfully')

      // Check if filename appears in the UI
      const fileNameDisplay = page.locator('p:has-text("test-layout")')
      const fileNameVisible = await fileNameDisplay.count() > 0
      console.log(`File name displayed in UI: ${fileNameVisible}`)

      testResult4.passed = true

      // Capture after file selection
      const screenshotPath4 = path.join(SCREENSHOT_DIR, '02-file-selected.png')
      await page.screenshot({ path: screenshotPath4, fullPage: true })
      testResult4.screenshots.push(screenshotPath4)
    } catch (error: any) {
      testResult4.error = error.message
      console.log(`✗ File selection test failed: ${error.message}`)
    }

    testResult4.consoleMessages = [...consoleMessages]
    testResult4.networkErrors = [...networkErrors]
    results.push(testResult4)

    // Test 5: Test upload button disabled/enabled state
    console.log('\n=== Test 5: Upload Button State ===')
    const testResult5: TestResult = {
      name: 'Upload Button State',
      passed: false,
      consoleMessages: [],
      networkErrors: [],
      screenshots: []
    }

    try {
      const uploadButton = page.locator('button:has-text("Upload & Auto-Detect")')
      const isDisabled = await uploadButton.isDisabled()
      console.log(`Upload button disabled after file select: ${isDisabled}`)

      testResult5.passed = !isDisabled
    } catch (error: any) {
      testResult5.error = error.message
      console.log(`✗ Upload button state test failed: ${error.message}`)
    }

    testResult5.consoleMessages = [...consoleMessages]
    testResult5.networkErrors = [...networkErrors]
    results.push(testResult5)

    // Test 6: Check API endpoint availability
    console.log('\n=== Test 6: API Endpoints Check ===')
    const testResult6: TestResult = {
      name: 'API Endpoints Check',
      passed: false,
      consoleMessages: [],
      networkErrors: [],
      screenshots: []
    }

    try {
      // Test the upload endpoint without actually uploading
      const uploadEndpointResponse = await page.evaluate(() => {
        return fetch('/api/bartender/layout/upload', { method: 'OPTIONS' })
          .then(r => r.status)
          .catch(e => `Error: ${e.message}`)
      })

      console.log(`Upload endpoint response: ${uploadEndpointResponse}`)

      // Test the layout endpoint
      const layoutEndpointResponse = await page.evaluate(() => {
        return fetch('/api/bartender/layout', { method: 'OPTIONS' })
          .then(r => r.status)
          .catch(e => `Error: ${e.message}`)
      })

      console.log(`Layout endpoint response: ${layoutEndpointResponse}`)

      testResult6.passed = true
    } catch (error: any) {
      testResult6.error = error.message
      console.log(`✗ API endpoints check failed: ${error.message}`)
    }

    testResult6.consoleMessages = [...consoleMessages]
    testResult6.networkErrors = [...networkErrors]
    results.push(testResult6)

    // Test 7: Inspect page structure and DOM
    console.log('\n=== Test 7: Page Structure Analysis ===')
    const testResult7: TestResult = {
      name: 'Page Structure Analysis',
      passed: false,
      consoleMessages: [],
      networkErrors: [],
      screenshots: []
    }

    try {
      const pageStructure = await page.evaluate(() => {
        const structure = {
          hasFileInput: document.querySelector('input[type="file"]') !== null,
          fileInputAccept: document.querySelector('input[type="file"]')?.getAttribute('accept'),
          fileInputId: document.querySelector('input[type="file"]')?.getAttribute('id'),
          hasChooseButton: Array.from(document.querySelectorAll('button, div, label')).some(el =>
            el.textContent?.includes('Choose Image')
          ),
          hasUploadButton: Array.from(document.querySelectorAll('button')).some(el =>
            el.textContent?.includes('Upload & Auto-Detect')
          ),
          formCount: document.querySelectorAll('form').length,
          inputCount: document.querySelectorAll('input').length
        }
        return structure
      })

      console.log('Page Structure:', JSON.stringify(pageStructure, null, 2))
      testResult7.passed = pageStructure.hasFileInput && pageStructure.hasChooseButton

      // Capture page structure for debugging
      const screenshotPath7 = path.join(SCREENSHOT_DIR, '03-page-structure.png')
      await page.screenshot({ path: screenshotPath7, fullPage: true })
      testResult7.screenshots.push(screenshotPath7)
    } catch (error: any) {
      testResult7.error = error.message
      console.log(`✗ Page structure analysis failed: ${error.message}`)
    }

    testResult7.consoleMessages = [...consoleMessages]
    testResult7.networkErrors = [...networkErrors]
    results.push(testResult7)

    // Test 8: Test try clicking the upload button
    console.log('\n=== Test 8: Upload Button Click Attempt ===')
    const testResult8: TestResult = {
      name: 'Upload Button Click Attempt',
      passed: false,
      consoleMessages: [],
      networkErrors: [],
      screenshots: []
    }

    try {
      const uploadButton = page.locator('button:has-text("Upload & Auto-Detect")')
      const isDisabledBeforeClick = await uploadButton.isDisabled()
      console.log(`Upload button disabled: ${isDisabledBeforeClick}`)

      if (!isDisabledBeforeClick) {
        // Set up listener for responses
        let uploadAttempted = false
        page.on('response', response => {
          if (response.url().includes('/api/bartender/layout/upload')) {
            uploadAttempted = true
            console.log(`Upload endpoint called: ${response.status()}`)
          }
        })

        await uploadButton.click()
        console.log('Upload button clicked')

        // Wait for response
        await page.waitForTimeout(2000)

        // Capture after click
        const screenshotPath8 = path.join(SCREENSHOT_DIR, '04-after-upload-click.png')
        await page.screenshot({ path: screenshotPath8, fullPage: true })
        testResult8.screenshots.push(screenshotPath8)

        testResult8.passed = uploadAttempted
      } else {
        testResult8.error = 'Upload button is disabled'
      }
    } catch (error: any) {
      testResult8.error = error.message
      console.log(`✗ Upload button click test failed: ${error.message}`)
    }

    testResult8.consoleMessages = [...consoleMessages]
    testResult8.networkErrors = [...networkErrors]
    results.push(testResult8)

  } catch (error: any) {
    console.log(`\nFatal error during testing: ${error.message}`)
  } finally {
    await browser.close()
  }

  // Print summary
  console.log('\n\n========================================')
  console.log('TEST SUMMARY')
  console.log('========================================')

  let passCount = 0
  let failCount = 0

  for (const result of results) {
    const status = result.passed ? 'PASS' : 'FAIL'
    console.log(`[${status}] ${result.name}`)
    if (result.error) {
      console.log(`      Error: ${result.error}`)
    }
    if (result.consoleMessages.length > 0) {
      console.log(`      Console Messages: ${result.consoleMessages.length}`)
      result.consoleMessages.slice(0, 3).forEach(msg => console.log(`        - ${msg}`))
    }
    if (result.networkErrors.length > 0) {
      console.log(`      Network Errors: ${result.networkErrors.length}`)
      result.networkErrors.slice(0, 3).forEach(err => console.log(`        - ${err}`))
    }
    if (result.screenshots.length > 0) {
      console.log(`      Screenshots: ${result.screenshots.join(', ')}`)
    }

    if (result.passed) passCount++
    else failCount++
  }

  console.log(`\nTotal: ${passCount} passed, ${failCount} failed`)
  console.log(`\nScreenshots saved to: ${SCREENSHOT_DIR}`)

  // Create detailed report
  const reportPath = path.join(SCREENSHOT_DIR, 'TEST_REPORT.md')
  const reportContent = `# Layout Editor Test Report

Generated: ${new Date().toISOString()}

## Test Results Summary
- Passed: ${passCount}
- Failed: ${failCount}
- Total: ${results.length}

## Detailed Results

${results.map(r => `
### ${r.name}
- Status: ${r.passed ? 'PASS' : 'FAIL'}
${r.error ? `- Error: ${r.error}` : ''}
${r.consoleMessages.length > 0 ? `- Console Messages (${r.consoleMessages.length}):
${r.consoleMessages.map(m => `  - ${m}`).join('\n')}` : ''}
${r.networkErrors.length > 0 ? `- Network Errors (${r.networkErrors.length}):
${r.networkErrors.map(e => `  - ${e}`).join('\n')}` : ''}
${r.screenshots.length > 0 ? `- Screenshots:
${r.screenshots.map(s => `  - ${s}`).join('\n')}` : ''}
`).join('\n')}

## File Upload Test Details

The layout editor page includes:
1. File input element with accept="image/*"
2. Upload & Auto-Detect button
3. Layout preview canvas
4. Zone editing and management
5. Save functionality

## Screenshots Location
All screenshots have been saved to: \`${SCREENSHOT_DIR}\`

## Known Issues Found
${networkErrors.length > 0 ? `- Network Errors: ${networkErrors.join(', ')}` : '- No network errors detected'}
${consoleMessages.filter(m => m.includes('ERROR')).length > 0 ? `- Console Errors: ${consoleMessages.filter(m => m.includes('ERROR')).length} error(s) logged` : '- No console errors detected'}
`

  fs.writeFileSync(reportPath, reportContent)
  console.log(`\nDetailed report saved to: ${reportPath}`)
}

async function main() {
  await ensureScreenshotDir()
  await testLayoutEditor()
}

main().catch(console.error)
